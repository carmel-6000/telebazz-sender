<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Morse Code Sound Generator</title>

<!-- Material Design Lite https://getmdl.io -->
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.2.0/material.indigo-pink.min.css">
<script defer src="https://code.getmdl.io/1.2.0/material.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Contains dictionary of characters to morse code -->
<script defer src="morse_code_dict.js"></script>
<script src="Tone.min.js"></script>
<script src="//tonejs.github.io/build/Tone.min.js"></script>


<script defer type="text/javascript">

// Given string, returns list of chars converted to morse code
// ex.
// getMorse('Test') -> ["-", "...", ".", "-"]
function getMorse(message) {
  message = message.toUpperCase();
  morse = [];
  for (var i = 0; i < message.length; i++) {
    morse.push( char_to_morse[message[i]] );
  }
  return morse;
}

function SOS(sos){
  morse = [];
  for (var i = 0; i< sos.length; i++){//changes characters sos to morse using the dictionary
    morse.push( char_to_morse[sos[i]]);
  }
  return morse;
}

function ILoveU(ilu) {
  morse = [];
  for (var i = 0; i < ilu.length; i++) {//changes characters ilu to morse using the dictionary
    morse.push( char_to_morse[ilu[i]] );
  }
  return morse;
}

function Hello(hello) {
  morse = [];
  for (var i = 0; i < hello.length; i++) {//changes characters hello to morse using the dictionary
    morse.push( char_to_morse[hello[i]] );
  }
  return morse;
}

// All times in seconds
var dot_time = 0.070;
var dash_time = dot_time*3;
var inter_elem_time = 0.090;
var space_time = dot_time*7;

// Initial delay before starting morse code sequence
var initial_delay = 0.1;

// Track whether morse code is running
var running = false;

var addMorseText = function(morse_text) {
  document.querySelector('#morse').innerHTML += morse_text; //show morse code on the page in HTML
}
var clearMorseText = function() {
  document.querySelector('#morse').textContent = "";
}

var addMsgText = function(msg_text) {
  document.querySelector('#msg').innerHTML += msg_text; //show text on the page in HTML
}
var clearMsgText = function() {
  document.querySelector('#msg').textContent = "";
}

var stop_morse = function() {// stop it all
  Tone.Transport.cancel();
  tone_fin();
  clearMsgText();
  clearMorseText();
  document.querySelector('#p1').MaterialProgress.setProgress(0);
}

// The Morse Code tone to use, xHz sine wave
var osc = new Tone.Oscillator(8000, "sine").toMaster();

var tone_dot = function(time, char) {
  osc.start(time);
  console.log("time dot",time);
  osc.stop(time+dot_time);
  addMorseText('• ', char);
}
var tone_dash = function(time, char) {
  osc.start(time);
  console.log("time dash",time);
  osc.stop(time+dash_time);
  addMorseText('▬ ', char);
}

var tone_word_space = function(time) {
  addMorseText('<br />');
}

var tone_letter_space = function(time) {
  addMorseText(' ');
}

var tone_fin = function(time) {
  running = false;
  document.querySelector('#play').disabled = false;
}

var tone_addMsgText = function(time, char) {
  addMsgText(char);
}

// Move msg/code to global for easy access from console
var msg;
var code;
function longTone(){

}

function play_morse_sequence() {
  if (running) {
    return;
  }

  // clear previous
  stop_morse();

  document.querySelector('#play').disabled = true;

  running = true;

  msg = document.querySelector('#input_msg').value.toUpperCase();//get the message from the html
  document.querySelector('#input_msg').value = msg;
  code = getMorse(msg);//call the function using the msg
  console.log("code",code);
  console.log("Message:", msg, ", Code: ", code.join(' '));

  var total_length = morse.join('').length-1;

  var tone_updateProgress = function(time, pos) {
    var ratio = 100 * pos / total_length;//position the text
    document.querySelector('#p1').MaterialProgress.setProgress(ratio);
  }

  // Generate sequence
  var seq = [];
  var t = initial_delay; // Our current time in the morse code sequence
  var pos = 0;

  for (var i=0; i < code.length; i++) {
    var codeChar = code[i]; // morse code codeChar dash and dots

    // If the codeChar is just a space, handle differently
    if (codeChar === ' ') {
      // Push codeChar space
      seq.push({"time":t, "func":tone_word_space});
      t += space_time;
    } else {
      // We have a morse code codeChar
      if (typeof codeChar == 'undefined') {
        console.log("Skip", msg[i]);
        continue;
      }
      for (var j=0; j < codeChar.length; j++) {
        var char = codeChar[j]; // morse code character
        if (char === '.') {
          // Push a tone_dot
          seq.push({"time":t, "func":tone_dot});
          t += dot_time;
        } else if (char === '-') {
          // Push tone_dash
          seq.push({"time":t, "func":tone_dash});
          t += dash_time;
        } else {
          console.log('Unexpected character in morse code message:', char);
        }
        // Add inter element pause between characters
        t += inter_elem_time;
        pos += 1;
        // Add update to progress bar
        seq.push({"time":t, "func":tone_updateProgress, "msg_char":pos});
      }
      // Add inter-letter space
      if (i < code.length - 1 && code[i+1] !== ' ') {
        seq.push({"time":t, "func":tone_letter_space});
        t += space_time;
      }
    }
    // Add message text to screen
    seq.push({"time":t, "func":tone_addMsgText, "msg_char":msg[i]});

  }
  seq.push({"time":t, "func":tone_fin});

  var part = new Tone.Part(function(time, obj) {
    if (typeof obj.msg_char != 'undefined') {
      obj.func(time, obj.msg_char);
      // console.log(time.toFixed(3), obj.func.name, obj.msg_char);
    } else {
      obj.func(time);
      // console.log(time.toFixed(3), obj.func.name);
    }
  }, seq).start();

  // Start sequence
  Tone.start();
}
//SOS
function play_sos() {
  if (running) {
    return;
  }

  // clear previous
  stop_morse();

  document.querySelector('#play').disabled = true;

  running = true;
  var sos = "SOS";
  code = SOS(sos);
  console.log("code",code);
  console.log("Message: SOS Code: ", code.join(' '));

  var total_length = morse.join('').length-1;

  var tone_updateProgress = function(time, pos) {
    var ratio = 100 * pos / total_length;
    document.querySelector('#p1').MaterialProgress.setProgress(ratio);
  }

  // Generate sequence
  var seq = [];
  var t = initial_delay; // Our current time in the morse code sequence
  var pos = 0;

  for (var i=0; i < code.length; i++) {
    var codeChar = code[i]; // morse code codeChar
    console.log("codeChar",codeChar);
    // If the codeChar is just a space, handle differently
    if (codeChar === ' ') {
      // Push codeChar space
      seq.push({"time":t, "func":tone_word_space});
      t += space_time;
    } else {
      // We have a morse code codeChar
      if (typeof codeChar == 'undefined') {
        console.log("Skip", sos[i]);
        continue;
      }
      for (var j=0; j < codeChar.length; j++) {
        var char = codeChar[j]; // morse code character
        if (char === '.') {
          // Push a tone_dot
          seq.push({"time":t, "func":tone_dot});
          t += dot_time;
        } else if (char === '-') {
          // Push tone_dash
          seq.push({"time":t, "func":tone_dash});
          t += dash_time;
        } else {
          console.log('Unexpected character in morse code message:', char);
        }
        // Add inter element pause between characters
        t += inter_elem_time;
        pos += 1;
        // Add update to progress bar
        seq.push({"time":t, "func":tone_updateProgress, "msg_char":pos});
      }
      // Add inter-letter space
      if (i < code.length - 1 && code[i+1] !== ' ') {
        seq.push({"time":t, "func":tone_letter_space});
        t += space_time;
      }
    }
    // Add message text to screen
    seq.push({"time":t, "func":tone_addMsgText, "msg_char":sos[i]});

  }
  seq.push({"time":t, "func":tone_fin});

  var part = new Tone.Part(function(time, obj) {
    if (typeof obj.msg_char != 'undefined') {
      obj.func(time, obj.msg_char);
      // console.log(time.toFixed(3), obj.func.name, obj.msg_char);
    } else {
      obj.func(time);
      // console.log(time.toFixed(3), obj.func.name);
    }
  }, seq).start();

  // Start sequence
  Tone.Transport.start();
}

//ILU
function play_ilu() {
  if (running) {
    return;
  }

  // clear previous
  stop_morse();

  document.querySelector('#play').disabled = true;

  running = true;
  var ilu = "I LOVE YOU";
  code = ILoveU(ilu);
  console.log("code",code);
  console.log("Message: SOS Code: ", code.join(' '));

  var total_length = morse.join('').length-1;

  var tone_updateProgress = function(time, pos) {
    var ratio = 100 * pos / total_length;
    document.querySelector('#p1').MaterialProgress.setProgress(ratio);
  }

  // Generate sequence
  var seq = [];
  var t = initial_delay; // Our current time in the morse code sequence
  var pos = 0;

  for (var i=0; i < code.length; i++) {
    var codeChar = code[i]; // morse code codeChar
    console.log("codeChar",codeChar);
    // If the codeChar is just a space, handle differently
    if (codeChar === ' ') {
      // Push codeChar space
      seq.push({"time":t, "func":tone_word_space});
      t += space_time;
    } else {
      // We have a morse code codeChar
      if (typeof codeChar == 'undefined') {
        console.log("Skip", ilu[i]);
        continue;
      }
      for (var j=0; j < codeChar.length; j++) {
        var char = codeChar[j]; // morse code character
        if (char === '.') {
          // Push a tone_dot
          seq.push({"time":t, "func":tone_dot});
          t += dot_time;
        } else if (char === '-') {
          // Push tone_dash
          seq.push({"time":t, "func":tone_dash});
          t += dash_time;
        } else {
          console.log('Unexpected character in morse code message:', char);
        }
        // Add inter element pause between characters
        t += inter_elem_time;
        pos += 1;
        // Add update to progress bar
        seq.push({"time":t, "func":tone_updateProgress, "msg_char":pos});
      }
      // Add inter-letter space
      if (i < code.length - 1 && code[i+1] !== ' ') {
        seq.push({"time":t, "func":tone_letter_space});
        t += space_time;
      }
    }
    // Add message text to screen
    seq.push({"time":t, "func":tone_addMsgText, "msg_char":ilu[i]});

  }
  seq.push({"time":t, "func":tone_fin});

  var part = new Tone.Part(function(time, obj) {
    if (typeof obj.msg_char != 'undefined') {
      obj.func(time, obj.msg_char);
      // console.log(time.toFixed(3), obj.func.name, obj.msg_char);
    } else {
      obj.func(time);
      // console.log(time.toFixed(3), obj.func.name);
    }
  }, seq).start();

  // Start sequence
  Tone.Transport.start();
}

//HELLO
function play_hello() {
  if (running) {
    return;
  }

  // clear previous
  stop_morse();

  document.querySelector('#play').disabled = true;

  running = true;
  var hello = "HELLO";
  code = Hello(hello);
  console.log("code",code);
  console.log("Message: SOS Code: ", code.join(' '));

  var total_length = morse.join('').length-1;

  var tone_updateProgress = function(time, pos) {
    var ratio = 100 * pos / total_length;
    document.querySelector('#p1').MaterialProgress.setProgress(ratio);
  }

  // Generate sequence
  var seq = [];
  var t = initial_delay; // Our current time in the morse code sequence
  var pos = 0;

  for (var i=0; i < code.length; i++) {
    var codeChar = code[i]; // morse code codeChar
    console.log("codeChar",codeChar);
    // If the codeChar is just a space, handle differently
    if (codeChar === ' ') {
      // Push codeChar space
      seq.push({"time":t, "func":tone_word_space});
      t += space_time;
    } else {
      // We have a morse code codeChar
      if (typeof codeChar == 'undefined') {
        console.log("Skip", hello[i]);
        continue;
      }
      for (var j=0; j < codeChar.length; j++) {
        var char = codeChar[j]; // morse code character
        if (char === '.') {
          // Push a tone_dot
          seq.push({"time":t, "func":tone_dot});
          t += dot_time;
        } else if (char === '-') {
          // Push tone_dash
          seq.push({"time":t, "func":tone_dash});
          t += dash_time;
        } else {
          console.log('Unexpected character in morse code message:', char);
        }
        // Add inter element pause between characters
        t += inter_elem_time;
        pos += 1;
        // Add update to progress bar
        seq.push({"time":t, "func":tone_updateProgress, "msg_char":pos});
      }
      // Add inter-letter space
      if (i < code.length - 1 && code[i+1] !== ' ') {
        seq.push({"time":t, "func":tone_letter_space});
        t += space_time;
      }
    }
    // Add message text to screen
    seq.push({"time":t, "func":tone_addMsgText, "msg_char":hello[i]});

  }
  seq.push({"time":t, "func":tone_fin});

  var part = new Tone.Part(function(time, obj) {
    if (typeof obj.msg_char != 'undefined') {
      obj.func(time, obj.msg_char);
      // console.log(time.toFixed(3), obj.func.name, obj.msg_char);
    } else {
      obj.func(time);
      // console.log(time.toFixed(3), obj.func.name);
    }
  }, seq).start();

  // Start sequence
  Tone.Transport.start();
}

</script>

</head>

<body>
<div align="center">
  <h1>Morse Code Generator </h1>
  <br />
  <div>
      <!-- Simple Textfield -->
    <div class="mdl-textfield mdl-js-textfield">
      <input class="mdl-textfield__input" type="text" id="input_msg" onblur="stop_morse()" autocomplete="off" >
      <label class="mdl-textfield__label" for="input_msg">Write message here...</label>
    </div>
    <br />
    <button id="play" onclick="play_morse_sequence();">Play Morse Sequence</button>
    <button onclick="longTone();">Tone</button>
      <br /> <br /> <p>Preprogrammed Messages</p>
    <button onclick="play_sos();">SOS</button>
    <button onclick="play_ilu();">I love you</button>
    <button onclick="play_hello();">Hello</button>
  </div>
  <br />
  <div>
    <!-- Simple MDL Progress Bar -->
    <div id="p1" class="mdl-progress mdl-js-progress"></div>
  </div>
  <br />
  <button onclick="stop_morse();">Stop</button>
  <br /><br />
  <p id="msg"></p>
  <pre id="morse" style="overflow: auto;"></pre>
  <br />
</div>

</body>
</html>
